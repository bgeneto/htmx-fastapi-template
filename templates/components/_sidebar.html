<!-- Sidebar with resizable functionality and data-driven menu -->
{% set sidebar = request | sidebar %}
<!-- Pass sidebar data via script tag to avoid JSON escaping issues in HTML attributes -->
<script id="sidebar-data" type="application/json">{{ sidebar | tojson | safe }}</script>
<aside x-data="sidebarMenu()"
       x-init="init()"
       id="sidebar"
       class="fixed inset-y-0 left-0 z-40 transition-transform bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700 md:translate-x-0 w-[var(--sidebar-width)] transition-[width] duration-200 ease-in-out"
       :class="sidebarIsOpen ? 'translate-x-0' : '-translate-x-full'"
       @click.away="sidebarIsOpen = false"
       @keydown.escape.window="sidebarIsOpen = false"
       aria-label="{{ _('Sidebar navigation') }}"
       role="complementary">
    <div class="flex flex-col h-full px-4 py-4 overflow-y-auto my-2">
        <!-- Logo and Collapse Button -->
        <div class="flex items-center pl-2.5 mb-6"
             :class="collapsed ? 'justify-center' : 'justify-between'">
            <a href="/" class="flex items-center" x-show="!collapsed">
                <span class="self-center text-xl font-semibold whitespace-nowrap text-onSurfaceStrong dark:text-onSurfaceDarkStrong">
                    ALP
                </span>
            </a>
            <!-- Collapse/Expand Button - ALWAYS VISIBLE -->
            <button type="button"
                    @click="toggleCollapse()"
                    :aria-expanded="!collapsed"
                    :aria-label="collapsed ? '{{ _('Expand sidebar') }}' : '{{ _('Collapse sidebar') }}'"
                    class="hidden md:flex p-1.5 rounded-md bg-surface hover:bg-primary/10 dark:bg-surfaceDark dark:hover:bg-primaryDark/10 focus:outline-none transition-all -mr-2.5"
                    :title="collapsed ? '{{ _('Expand sidebar') }}' : '{{ _('Collapse sidebar') }}'">
                <!-- Expand icon when collapsed -->
                <i x-show="collapsed"
                   class="fa-solid fa-angles-right w-5 h-5 text-onSurface dark:text-onSurfaceDark flex items-center justify-center"
                   x-cloak></i>
                <!-- Collapse icon when expanded -->
                <i x-show="!collapsed"
                   class="fa-solid fa-angles-left w-5 h-5 text-onSurface dark:text-onSurfaceDark flex items-center justify-center"></i>
            </button>
        </div>

        <!-- Navigation - Data-driven rendering -->
        <nav class="flex-1 space-y-1" aria-label="{{ _('Main navigation') }}">
            <template x-for="section in sections" :key="section.key">
                <div>
                    <!-- Section Header with separator -->
                    <template x-if="section.show_header">
                        <div class="pt-4 mt-4 border-t border-border-light dark:border-borderDark">
                            <div class="flex items-center px-2 mb-2" x-show="!collapsed">
                                <span class="text-xs font-semibold uppercase text-onSurface/60 dark:text-onSurfaceDark/60"
                                      x-text="section.label"></span>
                            </div>
                        </div>
                    </template>

                    <!-- Menu Items -->
                    <template x-for="item in section.items" :key="item.key">
                        <div>
                            <!-- Item WITHOUT children (simple link) -->
                            <template x-if="!item.has_children">
                                <a :href="item.route"
                                   class="group flex items-center gap-2 py-1.5 text-sm font-medium rounded transition-all underline-offset-2 focus:outline-hidden focus-visible:underline"
                                   :class="[
                                       item.is_active
                                           ? 'bg-primary/10 text-onSurfaceStrong border-l-3 border-primary dark:bg-primaryDark/10 dark:text-onSurfaceDarkStrong dark:border-primaryDark'
                                           : 'text-onSurface hover:bg-primary/5 hover:text-onSurfaceStrong dark:text-onSurfaceDark dark:hover:bg-primaryDark/5 dark:hover:text-onSurfaceDarkStrong',
                                       collapsed ? 'justify-center px-4' : 'px-2'
                                   ]">
                                    <!-- Single icon: solid when active, regular otherwise (no hover effect for simplicity) -->
                                    <span class="flex-shrink-0 w-5 h-5 flex items-center justify-center"
                                          :class="collapsed ? 'text-lg' : 'text-base'">
                                        <i :class="[item.icon, item.is_active ? 'fa-solid' : 'fa-regular']"></i>
                                    </span>
                                    <span x-show="!collapsed" x-text="item.label" class="flex-1"></span>
                                    <!-- Badge -->
                                    <template x-if="item.badge && !collapsed">
                                        <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-medium rounded-full text-white"
                                              :class="item.badge_color"
                                              x-text="item.badge"></span>
                                    </template>
                                </a>
                            </template>

                            <!-- Item WITH children (expandable parent) -->
                            <template x-if="item.has_children">
                                <div>
                                    <!-- Parent button -->
                                    <button type="button"
                                            @click="toggleSubmenu(item.key)"
                                            class="group w-full flex items-center gap-2 py-1.5 text-sm font-medium rounded transition-all underline-offset-2 focus:outline-hidden focus-visible:underline"
                                            :class="[
                                                item.is_active
                                                    ? 'bg-primary/10 text-onSurfaceStrong border-l-3 border-primary dark:bg-primaryDark/10 dark:text-onSurfaceDarkStrong dark:border-primaryDark'
                                                    : 'text-onSurface hover:bg-primary/5 hover:text-onSurfaceStrong dark:text-onSurfaceDark dark:hover:bg-primaryDark/5 dark:hover:text-onSurfaceDarkStrong',
                                                collapsed ? 'justify-center px-4' : 'px-2'
                                            ]"
                                            :aria-expanded="isExpanded(item.key)">
                                        <!-- Single icon: solid when active/expanded, regular otherwise -->
                                        <span class="flex-shrink-0 w-5 h-5 flex items-center justify-center"
                                              :class="collapsed ? 'text-lg' : 'text-base'">
                                            <i :class="[item.icon, (item.is_active || isExpanded(item.key)) ? 'fa-solid' : 'fa-regular']"></i>
                                        </span>
                                        <span x-show="!collapsed" x-text="item.label" class="flex-1 text-left"></span>
                                        <!-- Chevron indicator -->
                                        <i x-show="!collapsed"
                                           class="fa-solid fa-chevron-down text-xs transition-transform duration-200"
                                           :class="isExpanded(item.key) ? 'rotate-180' : ''"></i>
                                    </button>

                                    <!-- Children submenu (collapsible) -->
                                    <div x-show="!collapsed && isExpanded(item.key)"
                                         x-collapse
                                         class="mt-1 ml-4 pl-3 border-l border-border-light dark:border-borderDark space-y-1">
                                        <template x-for="child in item.children" :key="child.key">
                                            <a :href="child.route"
                                               class="group flex items-center gap-2 px-2 py-1.5 text-sm font-medium rounded transition-all underline-offset-2 focus:outline-hidden focus-visible:underline"
                                               :class="child.is_active
                                                   ? 'bg-primary/10 text-onSurfaceStrong dark:bg-primaryDark/10 dark:text-onSurfaceDarkStrong'
                                                   : 'text-onSurface/80 hover:bg-primary/5 hover:text-onSurfaceStrong dark:text-onSurfaceDark/80 dark:hover:bg-primaryDark/5 dark:hover:text-onSurfaceDarkStrong'">
                                                <!-- Single icon: solid when active, regular otherwise -->
                                                <span class="flex-shrink-0 w-4 h-4 flex items-center justify-center text-sm">
                                                    <i :class="[child.icon, child.is_active ? 'fa-solid' : 'fa-regular']"></i>
                                                </span>
                                                <span x-text="child.label" class="flex-1"></span>
                                                <!-- Child badge -->
                                                <template x-if="child.badge">
                                                    <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-medium rounded-full text-white"
                                                          :class="child.badge_color"
                                                          x-text="child.badge"></span>
                                                </template>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </nav>
    </div>

    <!-- Resize handle (hidden on mobile) -->
    <div x-show="!collapsed"
         class="hidden md:flex absolute right-0 top-0 h-full items-center group"
         @pointerdown.prevent="startDrag($event)"
         title="{{ _('Drag to resize sidebar') }}">
        <div role="slider"
             aria-label="{{ _('Resize sidebar - drag or use arrow keys') }}"
             tabindex="0"
             class="resize-handle relative flex items-center justify-center bg-transparent hover:bg-primary/10 dark:hover:bg-primaryDark/10 transition-colors"
             @pointerdown.prevent.stop="startDrag($event)"
             @keydown.prevent.stop="handleKeydown($event)">
            <div class="flex flex-col gap-1 opacity-30 group-hover:opacity-100 transition-opacity">
                <div class="w-1 h-1 rounded-full bg-onSurface dark:bg-onSurfaceDark"></div>
                <div class="w-1 h-1 rounded-full bg-onSurface dark:bg-onSurfaceDark"></div>
                <div class="w-1 h-1 rounded-full bg-onSurface dark:bg-onSurfaceDark"></div>
            </div>
        </div>
        <div class="handle-hit" @pointerdown.prevent.stop="startDrag($event)"></div>
    </div>
</aside>

<!-- Mobile Overlay -->
<div x-show="sidebarIsOpen"
     class="fixed inset-0 z-30 bg-gray-900 bg-opacity-50 dark:bg-opacity-80 md:hidden"
     @click="sidebarIsOpen = false"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     x-cloak></div>

<!-- Sidebar Menu Alpine Component -->
<script>
function sidebarMenu() {
    // Read sidebar data from the script tag to avoid JSON escaping issues
    const dataElement = document.getElementById('sidebar-data');
    const initialData = dataElement ? JSON.parse(dataElement.textContent) : { sections: [], user_role: 'guest' };

    // Merge with resizable sidebar functionality
    const resizable = resizableSidebar({ key: 'sidebarWidthCSSVar', defaultWidth: 240, minWidth: 160, maxWidth: 300 });

    return {
        // Data from server
        sections: initialData.sections || [],
        userRole: initialData.user_role || 'guest',

        // Submenu state (accordion - only one open at a time)
        expandedKey: null,

        // Inherit resizable properties
        ...resizable,

        init() {
            // Initialize resizable sidebar
            resizable.init.call(this);

            // Restore expanded submenu from localStorage
            const savedKey = localStorage.getItem('sidebar_expanded');
            if (savedKey) {
                this.expandedKey = savedKey;
            }

            // Auto-expand parent of active child
            this.sections.forEach(section => {
                section.items.forEach(item => {
                    if (item.has_children && item.children) {
                        const hasActiveChild = item.children.some(child => child.is_active);
                        if (hasActiveChild || item.default_expanded) {
                            this.expandedKey = item.key;
                        }
                    }
                });
            });
        },

        isExpanded(key) {
            return this.expandedKey === key;
        },

        toggleSubmenu(key) {
            // Accordion behavior: close others when opening one
            if (this.expandedKey === key) {
                this.expandedKey = null;
                localStorage.removeItem('sidebar_expanded');
            } else {
                this.expandedKey = key;
                localStorage.setItem('sidebar_expanded', key);
            }
        },

        // Delegate resize methods to resizable
        toggleCollapse() {
            resizable.toggleCollapse.call(this);
        },
        startDrag(event) {
            resizable.startDrag.call(this, event);
        },
        handleKeydown(event) {
            resizable.handleKeydown.call(this, event);
        }
    };
}
</script>
