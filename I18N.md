# Internationalization (i18n) Guide

This project implements comprehensive internationalization support using **Babel** and **Jinja2 i18n extensions**, allowing the application to be displayed in multiple languages.

## ğŸŒ Overview

The i18n implementation covers:
- **Template strings**: All UI labels, buttons, and messages
- **Server-side validation**: Pydantic error messages
- **Client-side validation**: JavaScript error messages (injected from server)
- **Dynamic content**: Success messages with user data

## ğŸ—ï¸ Architecture

### Components

1. **Babel** - Industry-standard Python i18n library for message extraction and compilation
2. **Jinja2 i18n Extension** - Built-in template translation support
3. **Context Variables** - Thread-safe locale storage per request
4. **Middleware** - Automatic locale detection from Accept-Language headers or cookies

### File Structure

```
alpine-fastapi/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ i18n.py                    # i18n utilities and gettext functions
â”‚   â”œâ”€â”€ main.py                    # Middleware and Jinja2 configuration
â”‚   â””â”€â”€ schemas.py                 # Translatable validation messages
â”œâ”€â”€ translations/                   # Translation files directory
â”‚   â””â”€â”€ pt_BR/                     # Portuguese (Brazil) translations
â”‚       â””â”€â”€ LC_MESSAGES/
â”‚           â”œâ”€â”€ messages.po        # Editable translation source
â”‚           â””â”€â”€ messages.mo        # Compiled binary (auto-generated)
â”œâ”€â”€ babel.cfg                      # Babel extraction configuration
â”œâ”€â”€ messages.pot                   # Master translation template
â””â”€â”€ translate.sh                   # Translation management script
```

## ğŸš€ Quick Start

### Adding a New Language

```bash
# Initialize Spanish translations
./translate.sh init es

# Initialize French translations
./translate.sh init fr
```

### Updating Translations

1. Edit the `.po` file for your locale:
   ```
   translations/pt_BR/LC_MESSAGES/messages.po
   ```

2. Find the `msgid` (original English text) and add translation in `msgstr`:
   ```po
   msgid "Name"
   msgstr "Nome"

   msgid "Email is required"
   msgstr "O e-mail Ã© obrigatÃ³rio"
   ```

3. Compile translations:
   ```bash
   ./translate.sh compile
   ```

4. Restart the application to see changes

## ğŸ› ï¸ Translation Workflow

### Full Workflow Commands

```bash
# Extract messages from code
./translate.sh extract

# Update existing translations with new messages
./translate.sh update

# Compile .po files to .mo files
./translate.sh compile

# Do all three in one step (recommended)
./translate.sh refresh

# List available locales
./translate.sh list
```

### Developer Workflow

When you add or modify translatable strings in the code:

1. **Extract** new messages:
   ```bash
   ./translate.sh extract
   ```

2. **Update** translation files:
   ```bash
   ./translate.sh update
   ```

3. **Edit** the `.po` files to add translations

4. **Compile** translations:
   ```bash
   ./translate.sh compile
   ```

Or simply run:
```bash
./translate.sh refresh
```

## ğŸ“ Usage in Code

### In Templates (Jinja2)

Use the `_()` function or `{% trans %}` tags:

```html
<!-- Simple translation -->
<label>{{ _('Name') }}</label>
<button>{{ _('Send Message') }}</button>

<!-- Translation with variables -->
<p>{{ _('Thanks %(name)s â€” your message has been received!', name=contact.name) }}</p>

<!-- Block translation -->
{% trans %}Contact us{% endtrans %}
```

### In Python Code

Import and use the `gettext` function:

```python
from app.i18n import gettext as _

# Simple translation
error_message = _('Name is required')

# In Pydantic validators
@field_validator('name')
@classmethod
def validate_name(cls, v: str) -> str:
    if not v or len(v.strip()) < 2:
        raise ValueError(_('Name must be at least 2 characters'))
    return v
```

### In JavaScript (Client-side)

Inject translated strings from the server:

```html
<script>
  const i18n = {
    nameRequired: "{{ _('Name is required') }}",
    emailInvalid: "{{ _('Please enter a valid email address') }}"
  };

  // Use in validation
  if (!name) {
    showError(i18n.nameRequired);
  }
</script>
```

## ğŸŒ Locale Detection & Switching

The application provides **both automatic detection and manual selection** for the best user experience.

### Automatic Detection

The system automatically detects the user's preferred language using:

1. **Cookie** (highest priority): `locale` cookie
2. **Accept-Language Header**: Browser language preference

On first visit, the application checks your browser's language settings and displays content in your preferred language automatically.

### Manual Language Selector

A **language selector UI component** is available in the top-right corner of every page (next to the theme toggle):

- ğŸŒ **Globe icon** shows current language
- Click to open dropdown menu
- Select from available languages
- Page reloads with new language
- Selection is saved in a cookie for future visits

**Supported Languages:**
- ğŸ‡ºğŸ‡¸ English (en)
- ğŸ‡§ğŸ‡· PortuguÃªs (Brasil)

### How They Work Together

1. **First visit**: Automatic detection from browser
2. **User changes language**: Cookie overrides auto-detection
3. **Return visit**: Cookie remembered, shows user's choice
4. **New browser/device**: Auto-detection kicks in again

This provides the best of both worlds:
- âœ… Automatic convenience for most users
- âœ… Manual control when needed
- âœ… Persistent across sessions

### Programmatic Language Switching

You can also change the language programmatically via JavaScript:

```javascript
// Using the built-in function (with loading indicator)
window.setLocale('pt_BR');  // Switch to Portuguese
window.setLocale('en');     // Switch to English

// Or manually with cookie
document.cookie = "locale=pt_BR; path=/; max-age=31536000; SameSite=Lax";
location.reload();
```

### Adding New Languages to the Selector

To add a new language to the dropdown menu, edit `templates/components/_language_selector.html`:

```html
<!-- Add Spanish example -->
<button onclick="window.setLocale('es')" data-locale-option="es"
    class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-between">
    <span class="flex items-center gap-2">
        <span class="text-xl">ğŸ‡ªğŸ‡¸</span>
        <span>EspaÃ±ol</span>
    </span>
    <svg class="w-4 h-4 text-blue-600 hidden" data-locale-check="es" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
    </svg>
</button>
```

Don't forget to:
1. Initialize the translation: `./translate.sh init es`
2. Add the locale code to the `localeMap` in the component's JavaScript
3. Compile translations: `./translate.sh compile`

### URL Parameter (Future Enhancement)

You can add URL-based language switching by modifying the middleware:

```python
# In app/main.py
locale = request.query_params.get("lang") or request.cookies.get("locale")
```

## ğŸ“‹ Supported Locales

Current translations:
- **English (en)** - Default
- **Portuguese Brazil (pt_BR)** - Complete

To add more languages, use:
```bash
./translate.sh init <locale_code>
```

Common locale codes:
- `es` - Spanish
- `fr` - French
- `de` - German
- `it` - Italian
- `ja` - Japanese
- `zh_CN` - Chinese (Simplified)
- `ru` - Russian

## ğŸ”§ Configuration

### Babel Configuration (`babel.cfg`)

```ini
[python: **.py]
[jinja2: **/templates/**.html]
encoding = utf-8
extensions = jinja2.ext.i18n
```

This tells Babel where to find translatable strings.

### Jinja2 Configuration (`app/main.py`)

```python
templates.env.add_extension("jinja2.ext.i18n")
templates.env.install_gettext_callables(
    gettext=lambda x: get_translations(get_locale()).gettext(x),
    ngettext=lambda s, p, n: get_translations(get_locale()).ngettext(s, p, n),
    newstyle=True
)
```

### Locale Middleware

Automatically sets the locale for each request based on cookies or Accept-Language headers.

## ğŸ§ª Testing Translations

### Test with Browser Language

Change your browser's language preference:
- **Chrome**: Settings â†’ Languages â†’ Add language â†’ Move to top
- **Firefox**: Settings â†’ Language â†’ Choose language

### Test with cURL

```bash
# Test Portuguese
curl -H "Accept-Language: pt-BR" http://localhost:8000/

# Test Spanish
curl -H "Accept-Language: es" http://localhost:8000/
```

### Test with Cookie

```bash
curl -H "Cookie: locale=pt_BR" http://localhost:8000/
```

## ğŸ“Š Translation Coverage

All user-facing strings are translatable:

âœ… Form labels (Name, Email, Message)
âœ… Buttons (Send Message, Reset, Delete)
âœ… Validation errors (server and client-side)
âœ… Success messages
âœ… Admin interface
âœ… Login page
âœ… Navigation elements

## ğŸ› Troubleshooting

### Translations not appearing

1. **Compile translations**:
   ```bash
   ./translate.sh compile
   ```

2. **Restart the application**

3. **Check locale detection**:
   ```python
   # Add to route for debugging
   from app.i18n import get_locale
   print(f"Current locale: {get_locale()}")
   ```

### Missing translations

1. **Extract messages**:
   ```bash
   ./translate.sh extract
   ```

2. **Update .po files**:
   ```bash
   ./translate.sh update
   ```

3. **Check for empty `msgstr` values** in `.po` files

### Translation caching issues

Translations are cached in memory. To clear:
```python
# In app/i18n.py, clear the cache
_translations_cache.clear()
```

Or simply restart the application.

## ğŸ”„ CI/CD Integration

Translation compilation is integrated into the development workflow:

### GitHub Actions CI

The CI workflow automatically:
1. âœ… Extracts all translatable messages
2. âœ… Updates translation files
3. âœ… Compiles translations (fails if .po files have errors)
4. âœ… Reports translation completeness statistics

This ensures translations are always valid before merging code.

### Docker Build

The Dockerfile compiles translations during the build process:
```dockerfile
RUN pybabel compile -d translations
```

This ensures production containers always have up-to-date compiled translations.

### Git Pre-commit Hook (Optional)

Install the pre-commit hook to automatically compile translations before each commit:

```bash
# Create symlink to install hook
ln -s ../../scripts/pre-commit.sh .git/hooks/pre-commit
```

This automatically:
- Compiles translations before commit
- Stages the compiled .mo files
- Prevents committing broken translations

### Deployment Strategy

**Compiled .mo files are committed to git** for these reasons:
- âœ… Faster deployments (no compilation needed)
- âœ… Works without babel in production
- âœ… Ensures exact same translations in all environments
- âœ… CI validates them before merge

**Only messages.pot is gitignored** (auto-generated template)

## ğŸ¯ Best Practices

1. **Always use translation functions** - Never hardcode user-facing strings
2. **Keep translations in context** - Short, clear strings are easier to translate
3. **Use placeholders** - `%(name)s` instead of concatenation
4. **Compile before deployment** - Include `.mo` files in production
5. **Test each locale** - Verify translations render correctly
6. **Update regularly** - Run `./translate.sh refresh` when adding features

## ğŸ“š Additional Resources

- [Babel Documentation](https://babel.pocoo.org/)
- [Jinja2 i18n Extension](https://jinja.palletsprojects.com/en/3.0.x/extensions/#i18n-extension)
- [GNU gettext Format](https://www.gnu.org/software/gettext/manual/html_node/PO-Files.html)

## ğŸ¤ Contributing Translations

To contribute a new language translation:

1. Initialize the locale: `./translate.sh init <locale>`
2. Edit `translations/<locale>/LC_MESSAGES/messages.po`
3. Compile: `./translate.sh compile`
4. Test the translations
5. Submit a pull request

---

**Questions?** Check the main [README.md](README.md) or open an issue.
